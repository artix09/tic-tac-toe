<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏: –∫–æ–¥—ã –∫–æ–º–Ω–∞—Ç, —á–∞—Ç, —Å—á—ë—Ç</title>

  <style>
    :root{
      --bg:#ffffff; --fg:#111; --cell:#fff; --border:#222; --muted:#666; --accent:#111;
      --shadow: rgba(0,0,0,.08);
    }
    body.dark{
      --bg:#0f1115; --fg:#e8e8ea; --cell:#1a1d24; --border:#444; --muted:#a0a0a6; --accent:#e8e8ea;
      --shadow: rgba(0,0,0,.35);
    }
    body.classic{
      --bg:#071b10; --fg:#b9ffcf; --cell:#0b2a19; --border:#22c55e; --muted:#7dffad; --accent:#22c55e;
      --shadow: rgba(0,0,0,.25);
    }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:var(--bg); color:var(--fg);
      font-family:system-ui,Segoe UI,Arial;
      transition:.2s;
    }
    .wrap{width:min(920px, 96vw); display:grid; gap:12px; padding:16px}
    .top{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center}

    .ctrl, input.ctrl{
      padding:8px 12px; border-radius:12px;
      border:2px solid var(--border);
      background:var(--cell); color:var(--fg);
      font:inherit;
      box-shadow: 0 8px 20px var(--shadow);
    }
    .ctrl{cursor:pointer}
    input.ctrl{cursor:text}
    button.ctrl:active{transform: translateY(1px)}

    .pill{
      padding:6px 10px; border:2px dashed var(--border);
      border-radius:999px; color:var(--muted); font-size:13px
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .main{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width: 820px){ .main{grid-template-columns: 420px 1fr; align-items:start} }

    .boardCard{
      display:grid; gap:10px; justify-items:center;
      padding:14px; border:2px solid var(--border); border-radius:16px;
      background:var(--cell); box-shadow: 0 12px 30px var(--shadow);
    }
    #status{font-size:16px; text-align:center; color:var(--muted)}
    #score{font-size:14px; text-align:center; color:var(--muted)}
    .grid{display:grid; grid-template-columns:repeat(3, 110px); gap:10px}
    @media (max-width: 420px){ .grid{grid-template-columns:repeat(3, 92px)} }

    button.cell{
      width:110px; height:110px;
      border-radius:16px;
      border:2px solid var(--border);
      background:var(--bg);
      color:var(--fg);
      font-size:54px;
      cursor:pointer;
      transition: transform .12s;
      box-shadow: inset 0 0 0 999px rgba(255,255,255,0.0);
    }
    @media (max-width: 420px){ button.cell{width:92px; height:92px; font-size:46px} }
    button.cell:active{transform: scale(.98)}

    .mark{display:inline-block; animation: pop .14s ease-out; transform-origin:center;}
    @keyframes pop{ from{transform: scale(.6); opacity:.2} to{transform: scale(1); opacity:1} }

    .winGlow{ box-shadow: inset 0 0 0 999px rgba(34,197,94,.12); }
    body.dark .winGlow{ box-shadow: inset 0 0 0 999px rgba(34,197,94,.10); }
    body.classic .winGlow{ box-shadow: inset 0 0 0 999px rgba(185,255,207,.10); }

    .sideCard{
      padding:14px; border:2px solid var(--border); border-radius:16px;
      background:var(--cell); box-shadow: 0 12px 30px var(--shadow);
      display:grid; gap:10px;
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .row.tight{gap:6px}

    .chatLog{
      height:260px; overflow:auto;
      border:2px solid var(--border); border-radius:14px;
      padding:10px;
      background:var(--bg);
      color:var(--fg);
    }
    .msg{margin:6px 0; line-height:1.25}
    .msg small{color:var(--muted)}
    .msg.system{color:var(--muted); font-style:italic}

    .hint{color:var(--muted); font-size:13px}
    #typing{min-height:18px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <select id="mode" class="ctrl">
        <option value="ai">–ü—Ä–æ—Ç–∏–≤ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</option>
        <option value="pvp">–ù–∞ –¥–≤–æ–∏—Ö (–ª–æ–∫–∞–ª—å–Ω–æ)</option>
        <option value="online">–û–Ω–ª–∞–π–Ω (–∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã)</option>
      </select>

      <select id="level" class="ctrl">
        <option value="easy">–õ—ë–≥–∫–∞—è</option>
        <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
        <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
      </select>

      <select id="theme" class="ctrl">
        <option value="light" selected>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
        <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
        <option value="classic">üü© Classic</option>
      </select>

      <label class="pill">
        <input id="sound" type="checkbox" checked />
        –ó–≤—É–∫–∏
      </label>

      <button id="reset" class="ctrl">–ó–∞–Ω–æ–≤–æ</button>
      <button id="resetScore" class="ctrl">–°–±—Ä–æ—Å —Å—á—ë—Ç–∞</button>
    </div>

    <div class="main">
      <div class="boardCard">
        <div id="status">–•–æ–¥: X</div>
        <div id="score">–°—á—ë—Ç ‚Äî X: 0 ‚Ä¢ O: 0 ‚Ä¢ –ù–∏—á—å–∏: 0</div>
        <div class="grid" id="grid"></div>
        <div class="hint">–û–Ω–ª–∞–π–Ω: –ò–≥—Ä–æ–∫ 1 ¬´–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É¬ª ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥. –ò–≥—Ä–æ–∫ 2 –≤–≤–æ–¥–∏—Ç –∫–æ–¥ ‚Üí ¬´–í–æ–π—Ç–∏¬ª.</div>
      </div>

      <div class="sideCard">
        <div class="row">
          <span class="pill">–û–Ω–ª–∞–π–Ω</span>
          <span id="onlineState" class="pill">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
          <span class="pill">–í –∫–æ–º–Ω–∞—Ç–µ: <b id="roomCount" class="mono">0/2</b></span>
        </div>

        <div class="row tight">
          <button id="createRoom" class="ctrl">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <span class="pill">–ö–æ–¥: <b id="roomCode" class="mono">‚Äî</b></span>
          <button id="copyCode" class="ctrl">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <div class="row tight">
          <input id="joinCode" class="ctrl mono" placeholder="–ö–æ–¥ (A9K3QZ)" maxlength="6" />
          <button id="joinRoom" class="ctrl">–í–æ–π—Ç–∏</button>
          <button id="leaveRoom" class="ctrl">–í—ã–π—Ç–∏</button>
        </div>

        <div class="hint">‚ö†Ô∏è –û–Ω–ª–∞–π–Ω —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ https:// (GitHub Pages).</div>

        <div class="row">
          <span class="pill">–ß–∞—Ç</span>
        </div>

        <div id="chatLog" class="chatLog"></div>
        <div id="typing" class="hint"></div>

        <div class="row tight">
          <input id="chatInput" class="ctrl" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" style="flex:1 1 auto; min-width:200px" />
          <button id="sendChat" class="ctrl">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <script>
    // UI
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const scoreEl = document.getElementById('score');

    const modeEl = document.getElementById('mode');
    const levelEl = document.getElementById('level');
    const themeEl = document.getElementById('theme');
    const soundEl = document.getElementById('sound');

    const resetBtn = document.getElementById('reset');
    const resetScoreBtn = document.getElementById('resetScore');

    const onlineStateEl = document.getElementById('onlineState');
    const roomCountEl = document.getElementById('roomCount');
    const createRoomBtn = document.getElementById('createRoom');
    const roomCodeEl = document.getElementById('roomCode');
    const copyCodeBtn = document.getElementById('copyCode');
    const joinCodeEl = document.getElementById('joinCode');
    const joinRoomBtn = document.getElementById('joinRoom');
    const leaveRoomBtn = document.getElementById('leaveRoom');

    const chatLogEl = document.getElementById('chatLog');
    const typingEl = document.getElementById('typing');
    const chatInputEl = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChat');

    // Game state
    const X='X', O='O';
    let board = Array(9).fill('');
    let turn = X;
    let over = false;
    let winLine = null;

    const wins = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];

    // Score
    let score = { x:0, o:0, d:0 };
    function updateScore(){ scoreEl.textContent = `–°—á—ë—Ç ‚Äî X: ${score.x} ‚Ä¢ O: ${score.o} ‚Ä¢ –ù–∏—á—å–∏: ${score.d}`; }

    // Sounds (WebAudio)
    let audioCtx = null;
    function beep(freq=440, dur=0.06, type='sine', gain=0.06){
      if(!soundEl.checked) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq; g.gain.value = gain;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + dur);
      }catch(e){}
    }
    // ‚úÖ move sounds removed, win/lose added
    const SND = {
      moveX: ()=>{},
      moveO: ()=>{},
      win: () => {
        beep(740,0.07,'sine',0.07);
        setTimeout(()=>beep(980,0.08,'sine',0.07),70);
        setTimeout(()=>beep(1170,0.09,'sine',0.07),160);
      },
      lose: () => {
        beep(320,0.10,'sine',0.07);
        setTimeout(()=>beep(220,0.12,'sine',0.07),110);
      },
      draw:  ()=>beep(240,0.08,'sine',0.06),
      msg:   ()=>beep(620,0.03,'triangle',0.03)
    };

    // Chat
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function chatLine(text, who='system'){
      const div = document.createElement('div');
      div.className = 'msg ' + who;
      const t = new Date();
      const hh = String(t.getHours()).padStart(2,'0');
      const mm = String(t.getMinutes()).padStart(2,'0');
      if(who==='system'){
        div.textContent = text;
      }else{
        div.innerHTML = `<small>[${hh}:${mm}]</small> <b>${who==='me'?'–Ø':'–û–Ω(–∞)'}</b>: ${escapeHtml(text)}`;
      }
      chatLogEl.appendChild(div);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    // Render
    function setStatus(t){ statusEl.textContent = t; }

    function render(){
      grid.innerHTML='';
      board.forEach((v,i)=>{
        const btn = document.createElement('button');
        btn.className = 'cell';
        if(winLine && winLine.includes(i)) btn.classList.add('winGlow');
        btn.onclick = () => onCell(i);
        if(v){
          const span = document.createElement('span');
          span.className = 'mark';
          span.textContent = v;
          btn.appendChild(span);
        }
        grid.appendChild(btn);
      });
    }

    function empties(b=board){ const res=[]; for(let i=0;i<9;i++) if(!b[i]) res.push(i); return res; }

    function winner(b=board){
      for(const line of wins){
        const [a,b2,c] = line;
        if(b[a] && b[a]===b[b2] && b[a]===b[c]) return { w:b[a], line };
      }
      if(b.every(x=>x)) return { w:'draw', line:null };
      return null;
    }

    function statusText(){
      const mode = modeEl.value;
      if(mode==='online'){
        if(!online.ready) return '–û–Ω–ª–∞–π–Ω: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
        return `–û–Ω–ª–∞–π–Ω ‚Ä¢ –¢—ã: ${online.myMark} ‚Ä¢ –•–æ–¥: ${turn}`;
      }
      if(mode==='ai') return `–¢—ã: X ‚Ä¢ –ö–æ–º–ø—å—é—Ç–µ—Ä: O ‚Ä¢ –•–æ–¥: ${turn}`;
      return `–ù–∞ –¥–≤–æ–∏—Ö ‚Ä¢ –•–æ–¥: ${turn}`;
    }

    // ‚úÖ finish: win/lose sound logic
    function finish(w){
      over = true; winLine = w.line;

      if(w.w==='draw'){
        score.d++; updateScore();
        setStatus('–ù–∏—á—å—è ü§ù');
        SND.draw();
        render();
        return;
      }

      if(w.w===X) score.x++; else score.o++;
      updateScore();
      setStatus(`–ü–æ–±–µ–¥–∏–ª ${w.w} üéâ`);

      const mode = modeEl.value;
      let myMark = null;
      if(mode === 'ai') myMark = X;
      else if(mode === 'online' && online?.myMark) myMark = online.myMark;

      if(myMark){
        (w.w === myMark ? SND.win : SND.lose)();
      }else{
        // –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –¥–≤–æ–∏—Ö: –ø—Ä–æ—Å—Ç–æ "–ø–æ–±–µ–¥–∞"
        SND.win();
      }

      render();
    }

    // ‚úÖ applyMove: no click sounds
    function applyMove(i, mark){
      if(over || board[i]) return;
      board[i] = mark;
      turn = (turn===X)?O:X;
      render();
      setStatus(statusText());
    }

    function resetBoard(sendOnline=false){
      board = Array(9).fill('');
      turn = X; over = false; winLine = null;
      setStatus(statusText()); render();
      if(sendOnline) send({type:'resetBoard'});
    }
    function resetScore(sendOnline=false){
      score = {x:0,o:0,d:0}; updateScore();
      if(sendOnline) send({type:'score', score});
    }

    // Click cell
    function onCell(i){
      if(over || board[i]) return;

      const mode = modeEl.value;

      if(mode==='online'){
        if(!online.ready) return;
        if(turn !== online.myMark) return;
        applyMove(i, online.myMark);
        send({type:'move', i});
        const w = winner(); if(w) finish(w);
        return;
      }

      applyMove(i, turn);
      const w = winner(); if(w) return finish(w);

      if(mode==='ai' && turn===O){
        setStatus('–•–æ–¥ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞‚Ä¶');
        setTimeout(aiMove, 180);
      }else{
        setStatus(statusText());
      }
    }

    // AI
    function winMove(p){
      for(const i of empties()){
        const b = board.slice(); b[i]=p;
        const res = winner(b);
        if(res && res.w===p) return i;
      }
      return null;
    }
    function randomMove(){ const e=empties(); return e[Math.floor(Math.random()*e.length)]; }
    function minimax(b,p){
      const res = winner(b);
      if(res?.w===O) return {score:1};
      if(res?.w===X) return {score:-1};
      if(res?.w==='draw') return {score:0};

      let best = {score: p===O ? -Infinity : Infinity};
      for(const i of empties(b)){
        const bb=b.slice(); bb[i]=p;
        const r=minimax(bb, p===O?X:O);
        if(p===O && r.score>best.score) best={i,score:r.score};
        if(p===X && r.score<best.score) best={i,score:r.score};
      }
      return best;
    }
    function aiMove(){
      if(over || modeEl.value!=='ai' || turn!==O) return;
      let m=null;
      const lvl=levelEl.value;
      if(lvl==='easy') m=randomMove();
      else if(lvl==='normal') m=winMove(O) ?? winMove(X) ?? (!board[4]?4:null) ?? randomMove();
      else m=minimax(board.slice(), O).i ?? randomMove();

      applyMove(m, O);
      const w = winner(); if(w) finish(w);
      setStatus(statusText());
    }

    // ===== Online with room codes + typing indicator + online counter
    const online = {
      peer:null, conn:null, ready:false,
      role:null, myMark:null,
      code:null,
      count:0, otherPresent:false
    };

    function setOnlineState(t){ onlineStateEl.textContent = t; }
    function setRoomCount(n){ online.count = n; roomCountEl.textContent = `${n}/2`; }

    function makeCode(){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s=""; for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    function send(payload){
      if(online.conn && online.conn.open) online.conn.send(payload);
    }

    function showTyping(on){ typingEl.textContent = on ? '–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶' : ''; }
    let remoteTypingTimer = null;
    function remoteTyping(on){
      showTyping(on);
      if(remoteTypingTimer) clearTimeout(remoteTypingTimer);
      if(on) remoteTypingTimer = setTimeout(()=>showTyping(false), 2000);
    }

    function cleanupPeer(hard=true){
      try{ if(online.conn) online.conn.close(); }catch(e){}
      online.conn=null; online.ready=false; online.role=null; online.myMark=null;
      online.otherPresent=false;
      showTyping(false);
      setRoomCount(0);
      setOnlineState('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
      if(hard){
        try{ if(online.peer) online.peer.destroy(); }catch(e){}
        online.peer=null;
      }
    }

    function ensurePeerWithId(id){
      if(online.peer && online.peer.id===id) return;
      cleanupPeer(false);

      online.peer = new Peer(id);

      online.peer.on('open', pid => {
        setOnlineState('–ì–æ—Ç–æ–≤ (ID: '+pid+')');
      });

      // host accepts
      online.peer.on('connection', c => {
        online.conn = c;
        online.role = 'host';
        online.myMark = X;
        online.ready = true;
        wireConn();
        setOnlineState('–ü–æ–¥–∫–ª—é—á—ë–Ω ‚úÖ (—Ç—ã X)');
        chatLine('–ò–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è ‚úÖ', 'system');

        setRoomCount(2);
        online.otherPresent = true;

        send({type:'hello'});
        send({type:'score', score});
        resetBoard(true);
      });

      online.peer.on('error', err => {
        setOnlineState('–û—à–∏–±–∫–∞: ' + (err?.type || err?.message || err));
        chatLine('–û–Ω–ª–∞–π–Ω –æ—à–∏–±–∫–∞: ' + (err?.type || err?.message || err), 'system');
        if(String(err?.type).includes('unavailable')) chatLine('–ö–æ–¥ –∑–∞–Ω—è—Ç. –ù–∞–∂–º–∏ ¬´–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É¬ª –µ—â—ë —Ä–∞–∑.', 'system');
      });
    }

    function wireConn(){
      const c = online.conn;
      if(!c) return;

      c.on('open', () => {
        online.ready=true;
        setOnlineState('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ');
        setRoomCount(2);
        send({type:'hello'});
        setStatus(statusText());
      });

      c.on('data', msg => {
        if(!msg || typeof msg!=='object') return;

        if(msg.type==='hello'){
          online.otherPresent = true;
          setRoomCount(2);
        }

        if(msg.type==='move'){
          const otherMark = (online.myMark===X) ? O : X;
          if(!over && !board[msg.i]){
            applyMove(msg.i, otherMark);
            const w=winner(); if(w) finish(w);
          }
        }

        if(msg.type==='resetBoard'){
          resetBoard(false);
          chatLine('–î–æ—Å–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'system');
        }

        if(msg.type==='score' && msg.score){
          score = msg.score; updateScore();
        }

        if(msg.type==='chat' && typeof msg.text==='string'){
          SND.msg();
          chatLine(msg.text, 'other');
        }

        if(msg.type==='typing'){
          remoteTyping(!!msg.on);
        }
      });

      c.on('close', () => {
        chatLine('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ ‚ùå', 'system');
        setOnlineState('–û—Ç–∫–ª—é—á–µ–Ω–æ');
        online.ready=false;
        online.conn=null;
        online.otherPresent=false;
        showTyping(false);
        setRoomCount(1);
        setStatus(statusText());
      });
    }

    // Buttons
    function goOnlineMode(){ modeEl.value='online'; modeChanged(); }

    createRoomBtn.onclick = () => {
      goOnlineMode();
      const code = makeCode();
      online.code=code;
      roomCodeEl.textContent=code;

      setOnlineState('–°–æ–∑–¥–∞—é –∫–æ–º–Ω–∞—Ç—É‚Ä¶');
      chatLine('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è‚Ä¶', 'system');

      ensurePeerWithId(code);
      online.role='host';
      online.myMark=X;
      online.ready=false;
      setRoomCount(1);
      setStatus('–û–Ω–ª–∞–π–Ω: –∂–¥—ë–º –∏–≥—Ä–æ–∫–∞‚Ä¶ (—Ç—ã X)');
    };

    joinRoomBtn.onclick = () => {
      goOnlineMode();
      const code = (joinCodeEl.value||'').trim().toUpperCase();
      if(code.length!==6){ chatLine('–í–≤–µ–¥–∏ –∫–æ–¥ –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤.', 'system'); return; }

      online.code=code;
      roomCodeEl.textContent=code;

      ensurePeerWithId(makeCode()); // guest random id
      setOnlineState('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å‚Ä¶');
      chatLine('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ '+code+'‚Ä¶', 'system');

      online.role='guest';
      online.myMark=O;

      setRoomCount(1);

      online.conn = online.peer.connect(code);
      wireConn();

      resetBoard(false);
      setStatus('–û–Ω–ª–∞–π–Ω: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶ (—Ç—ã O)');
    };

    copyCodeBtn.onclick = async () => {
      const code = roomCodeEl.textContent;
      if(!code || code==='‚Äî') return;
      try{ await navigator.clipboard.writeText(code); chatLine('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ', 'system'); SND.msg(); }
      catch(e){ chatLine('–ù–µ —Å–º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é: '+code, 'system'); }
    };

    leaveRoomBtn.onclick = () => {
      cleanupPeer(false);
      chatLine('–í—ã—à–µ–ª –∏–∑ –∫–æ–º–Ω–∞—Ç—ã.', 'system');
      setStatus(statusText());
    };

    // Typing indicator (send to opponent)
    let typingOn = false;
    let typingOffTimer = null;

    function setTyping(on){
      if(!online.ready) return;
      if(on === typingOn) return;
      typingOn = on;
      send({type:'typing', on});
    }

    chatInputEl.addEventListener('input', () => {
      if(modeEl.value !== 'online' || !online.ready) return;

      setTyping(true);

      if(typingOffTimer) clearTimeout(typingOffTimer);
      typingOffTimer = setTimeout(() => setTyping(false), 700);
    });

    chatInputEl.addEventListener('blur', () => {
      if(modeEl.value !== 'online' || !online.ready) return;
      setTyping(false);
    });

    function sendChat(){
      const t = (chatInputEl.value||'').trim();
      if(!t) return;
      chatInputEl.value='';
      setTyping(false);

      chatLine(t,'me'); SND.msg();
      send({type:'chat', text:t});
    }
    sendChatBtn.onclick = sendChat;
    chatInputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

    // Theme + Mode
    function applyTheme(){
      document.body.classList.remove('dark','classic');
      const t = themeEl.value;
      if(t==='dark') document.body.classList.add('dark');
      if(t==='classic') document.body.classList.add('classic');
    }

    function modeChanged(){
      const mode = modeEl.value;
      levelEl.disabled = (mode !== 'ai');
      if(mode !== 'online') showTyping(false);
      setStatus(statusText());
      resetBoard(false);
    }

    modeEl.onchange = modeChanged;
    themeEl.onchange = applyTheme;

    resetBtn.onclick = () => resetBoard(modeEl.value==='online');
    resetScoreBtn.onclick = () => resetScore(modeEl.value==='online');

    // Init
    applyTheme();
    updateScore();
    render();
    setStatus(statusText());
    setRoomCount(0);
    chatLine('–ì–æ—Ç–æ–≤–æ. –î–ª—è –æ–Ω–ª–∞–π–Ω–∞ –Ω–∞–∂–º–∏ ¬´–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É¬ª –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥.', 'system');
  </script>
</body>
  </html>
