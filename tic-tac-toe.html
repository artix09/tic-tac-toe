<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ + –æ–Ω–ª–∞–π–Ω)</title>

  <style>
    /* Themes */
    :root{
      --bg:#ffffff; --fg:#111; --cell:#fff; --border:#222; --muted:#666;
      --accent:#111;
    }
    body.dark{
      --bg:#0f1115; --fg:#e8e8ea; --cell:#1a1d24; --border:#444; --muted:#a0a0a6;
      --accent:#e8e8ea;
    }
    body.classic{
      --bg:#071b10; --fg:#b9ffcf; --cell:#0b2a19; --border:#22c55e; --muted:#7dffad;
      --accent:#22c55e;
    }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:var(--bg); color:var(--fg);
      font-family:system-ui,Segoe UI,Arial;
      transition:.2s;
    }
    .wrap{display:grid;gap:12px;justify-items:center;padding:18px}
    #status{font-size:16px;text-align:center;color:var(--muted);max-width:520px}
    .grid{display:grid;grid-template-columns:repeat(3,90px);gap:10px}
    button.cell{
      width:90px;height:90px;font-size:44px;cursor:pointer;
      border:2px solid var(--border);border-radius:14px;
      background:var(--cell);color:var(--fg);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
    .ctrl, input.ctrl{
      padding:8px 12px;border-radius:12px;
      border:2px solid var(--border);background:var(--cell);color:var(--fg);
      cursor:pointer;font:inherit;
    }
    input.ctrl{cursor:text; min-width:220px}
    .pill{
      padding:6px 10px;border:2px dashed var(--border);
      border-radius:999px;color:var(--muted);font-size:13px
    }
    .onlineBox{display:none; gap:8px; flex-wrap:wrap; justify-content:center}
    .onlineBox.show{display:flex}
    a{color:var(--accent)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row">
      <select id="mode" class="ctrl" title="–†–µ–∂–∏–º">
        <option value="ai">–ü—Ä–æ—Ç–∏–≤ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</option>
        <option value="pvp">–ù–∞ –¥–≤–æ–∏—Ö (–ª–æ–∫–∞–ª—å–Ω–æ)</option>
        <option value="online">–û–Ω–ª–∞–π–Ω –Ω–∞ –¥–≤–æ–∏—Ö</option>
      </select>

      <select id="level" class="ctrl" title="–°–ª–æ–∂–Ω–æ—Å—Ç—å (–¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞)">
        <option value="easy">–õ—ë–≥–∫–∞—è</option>
        <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
        <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
      </select>

      <select id="theme" class="ctrl" title="–¢–µ–º–∞">
        <option value="light" selected>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
        <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
        <option value="classic">üü© Classic</option>
      </select>

      <button id="reset" class="ctrl">–ó–∞–Ω–æ–≤–æ</button>
    </div>

    <div class="row onlineBox" id="onlineBox">
      <span class="pill" id="onlineHint">–û–Ω–ª–∞–π–Ω: –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ HTTPS (GitHub Pages)</span>
      <button id="hostBtn" class="ctrl">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      <span class="pill" id="myId">ID: ‚Äî</span>
      <input id="joinId" class="ctrl" placeholder="–í—Å—Ç–∞–≤—å ID –∫–æ–º–Ω–∞—Ç—ã –¥—Ä—É–≥–∞" />
      <button id="joinBtn" class="ctrl">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>

    <div id="status">–•–æ–¥: X</div>
    <div class="grid" id="grid"></div>

    <div class="row" style="max-width:520px; text-align:center; color:var(--muted); font-size:13px">
      –û–Ω–ª–∞–π–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PeerJS/WebRTC. –ï—Å–ª–∏ ‚Äú–Ω–µ –∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç—Å—è‚Äù ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ HTTPS/—Å–µ—Ç–∏ (NAT). 
    </div>
  </div>

  <!-- PeerJS (–Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞) -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <script>
    // ====== UI refs ======
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const resetBtn = document.getElementById('reset');
    const levelEl = document.getElementById('level');
    const modeEl = document.getElementById('mode');
    const themeEl = document.getElementById('theme');

    const onlineBox = document.getElementById('onlineBox');
    const hostBtn = document.getElementById('hostBtn');
    const joinBtn = document.getElementById('joinBtn');
    const joinIdEl = document.getElementById('joinId');
    const myIdEl = document.getElementById('myId');

    // ====== Game state ======
    const X='X', O='O';
    let board = Array(9).fill('');
    let turn = X;
    let over = false;

    // Online state
    let peer = null;
    let conn = null;
    let onlineRole = null; // "host" or "guest"
    let onlineReady = false;

    const wins = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];

    function winner(b=board){
      for(const [a,b2,c] of wins){
        if(b[a] && b[a]===b[b2] && b[a]===b[c]) return b[a];
      }
      if(b.every(v=>v)) return 'draw';
      return null;
    }
    function empties(b=board){
      return b.map((v,i)=>v?null:i).filter(v=>v!==null);
    }

    function setStatus(t){ statusEl.textContent = t; }

    function render(){
      grid.innerHTML='';
      board.forEach((v,i)=>{
        const btn=document.createElement('button');
        btn.className='cell';
        btn.textContent=v;
        btn.onclick=()=>onClickCell(i);
        grid.appendChild(btn);
      });
    }

    function endCheck(){
      const w = winner();
      if(!w) return false;
      over = true;
      if(w==='draw') setStatus('–ù–∏—á—å—è ü§ù');
      else setStatus(`–ü–æ–±–µ–¥–∏–ª ${w} üéâ`);
      return true;
    }

    // ====== Local gameplay ======
    function onClickCell(i){
      if(over || board[i]) return;

      const mode = modeEl.value;

      if(mode === 'online'){
        if(!onlineReady || !conn) return;
        // host –∏–≥—Ä–∞–µ—Ç X, guest –∏–≥—Ä–∞–µ—Ç O
        const myMark = (onlineRole === 'host') ? X : O;
        if(turn !== myMark) return;

        applyMove(i, myMark, true);
        conn.send({type:'move', i});
        return;
      }

      // –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã
      board[i]=turn;
      render();
      if(endCheck()) return;

      if(mode==='ai' && turn===X){
        turn = O;
        setStatus('–•–æ–¥ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞‚Ä¶');
        setTimeout(aiMove, 220);
      } else {
        turn = (turn===X)?O:X;
        setStatus(`–•–æ–¥: ${turn}`);
      }
    }

    function resetGame(sendOnline=false){
      board = Array(9).fill('');
      turn = X;
      over = false;
      setStatus(modeEl.value==='online'
        ? (onlineReady ? onlineStatusText() : '–û–Ω–ª–∞–π–Ω: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ')
        : '–•–æ–¥: X'
      );
      render();

      if(sendOnline && conn && onlineReady){
        conn.send({type:'reset'});
      }
    }

    // ====== AI ======
    function randomMove(){
      const e=empties();
      return e[Math.floor(Math.random()*e.length)];
    }
    function winMove(p){
      for(const i of empties()){
        const b=board.slice(); b[i]=p;
        if(winner(b)===p) return i;
      }
      return null;
    }
    function minimax(b,p){
      const w = winner(b);
      if(w===O) return {score: 1};
      if(w===X) return {score:-1};
      if(w==='draw') return {score:0};

      let best = {score: p===O ? -Infinity : Infinity};
      for(const i of empties(b)){
        const bb=b.slice(); bb[i]=p;
        const r=minimax(bb, p===O?X:O);
        if(p===O && r.score>best.score) best={i,score:r.score};
        if(p===X && r.score<best.score) best={i,score:r.score};
      }
      return best;
    }
    function aiMove(){
      if(over || modeEl.value!=='ai' || turn!==O) return;

      let m=null;
      const lvl=levelEl.value;

      if(lvl==='easy'){
        m=randomMove();
      }else if(lvl==='normal'){
        m = winMove(O) ?? winMove(X) ?? (!board[4]?4:null) ?? randomMove();
      }else{
        m = minimax(board.slice(), O).i ?? randomMove();
      }

      board[m]=O;
      render();
      if(endCheck()) return;
      turn=X;
      setStatus('–•–æ–¥: X');
    }

    // ====== Online (PeerJS) ======
    function onlineStatusText(){
      if(!onlineReady) return '–û–Ω–ª–∞–π–Ω: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
      const myMark = (onlineRole === 'host') ? X : O;
      return `–û–Ω–ª–∞–π–Ω ‚Ä¢ –¢—ã: ${myMark} ‚Ä¢ –•–æ–¥: ${turn}`;
    }

    function applyMove(i, mark, fromMe){
      if(over || board[i]) return;
      board[i] = mark;
      render();
      if(endCheck()) return;
      turn = (turn===X)?O:X;
      setStatus(onlineStatusText());
    }

    function ensurePeer(){
      if(peer) return;

      peer = new Peer(); // PeerJS Cloud by default
      peer.on('open', id => {
        myIdEl.textContent = 'ID: ' + id;
        setStatus(modeEl.value==='online' ? '–û–Ω–ª–∞–π–Ω: –≤—ã–±–µ—Ä–∏ "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É" –∏–ª–∏ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"' : statusEl.textContent);
      });

      peer.on('connection', c => {
        // Host accepts incoming
        conn = c;
        onlineRole = 'host';
        wireConn();
        onlineReady = true;
        setStatus('–û–Ω–ª–∞–π–Ω: –∏–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è ‚úÖ –¢—ã: X');
        resetGame(false);
      });

      peer.on('error', err => {
        setStatus('–û–Ω–ª–∞–π–Ω –æ—à–∏–±–∫–∞: ' + (err?.type || err?.message || err));
      });
    }

    function wireConn(){
      if(!conn) return;

      conn.on('open', () => {
        onlineReady = true;
        setStatus(onlineStatusText());
      });

      conn.on('data', msg => {
        if(!msg || typeof msg !== 'object') return;

        if(msg.type==='move'){
          // opposite mark
          const otherMark = (onlineRole === 'host') ? O : X;
          applyMove(msg.i, otherMark, false);
        }
        if(msg.type==='reset'){
          resetGame(false);
          setStatus(onlineStatusText());
        }
      });

      conn.on('close', () => {
        onlineReady = false;
        conn = null;
        setStatus('–û–Ω–ª–∞–π–Ω: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ ‚ùå');
      });
    }

    hostBtn.onclick = () => {
      modeEl.value = 'online';
      modeChanged();
      ensurePeer();
      onlineRole = 'host';
      onlineReady = false;
      setStatus('–û–Ω–ª–∞–π–Ω: –∂–¥—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶ (—Å–∫–∏–Ω—å –¥—Ä—É–≥—É —Å–≤–æ–π ID)');
    };

    joinBtn.onclick = () => {
      modeEl.value = 'online';
      modeChanged();
      ensurePeer();

      const roomId = (joinIdEl.value || '').trim();
      if(!roomId){ setStatus('–í—Å—Ç–∞–≤—å ID –∫–æ–º–Ω–∞—Ç—ã –¥—Ä—É–≥–∞.'); return; }

      onlineRole = 'guest';
      setStatus('–û–Ω–ª–∞–π–Ω: –ø–æ–¥–∫–ª—é—á–∞—é—Å—å‚Ä¶');
      conn = peer.connect(roomId);
      wireConn();
      // guest –∏–≥—Ä–∞–µ—Ç O, –∂–¥—ë–º –∫–æ–≥–¥–∞ host –Ω–∞—á–Ω—ë—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é X —Ö–æ–¥–∏—Ç)
      onlineReady = true;
      resetGame(false);
      setStatus('–û–Ω–ª–∞–π–Ω: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úÖ –¢—ã: O');
    };

    // ====== Theme + mode handlers ======
    function applyTheme(){
      document.body.classList.remove('dark','classic');
      const t = themeEl.value;
      if(t==='dark') document.body.classList.add('dark');
      if(t==='classic') document.body.classList.add('classic');
    }

    function modeChanged(){
      const mode = modeEl.value;

      onlineBox.classList.toggle('show', mode==='online');
      levelEl.disabled = (mode!=='ai');

      if(mode==='online'){
        ensurePeer();
        setStatus(onlineReady ? onlineStatusText() : '–û–Ω–ª–∞–π–Ω: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ (—Å–æ–∑–¥–∞–π –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Å—å)');
      } else {
        // –æ—Ç–∫–ª—é—á–∞–µ–º –æ–Ω–ª–∞–π–Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –æ—Ç –∏–≥—Ä—ã (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)
        onlineReady = false;
        onlineRole = null;
        setStatus('–•–æ–¥: X');
      }

      resetGame(false);
    }

    resetBtn.onclick = () => {
      const send = (modeEl.value==='online');
      resetGame(send);
    };

    themeEl.onchange = applyTheme;
    modeEl.onchange = modeChanged;

    // init
    applyTheme();
    render();
    setStatus('–•–æ–¥: X');
  </script>
</body>
</html>
